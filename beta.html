<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Peer GPS (2 phones) – jsQR版QRスキャン対応</title>
<style>
  :root{--bg:#0b1020;--panel:#131a33;--ink:#e8eefc;--muted:#9fb2d8;--accent:#5aa9ff;--good:#2ec27e;--warn:#f6c177;--bad:#ff6b6b}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{font-size:1.2rem;margin:4px 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--panel);border-radius:16px;box-shadow:0 8px 28px rgba(0,0,0,.25);padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1}
  label{font-weight:600;color:var(--muted);font-size:.9rem}
  input,textarea,button,select{width:100%;box-sizing:border-box;background:#0e1530;color:var(--ink);border:1px solid #26315e;border-radius:10px;padding:10px 12px}
  textarea{min-height:120px;resize:vertical}
  button{cursor:pointer;border:1px solid #3a4ea3;background:linear-gradient(180deg,#1a2560,#141d49);font-weight:700}
  button.primary{background:linear-gradient(180deg,#3170ff,#2651cc)}
  button.good{border-color:#1e5e3a;background:linear-gradient(180deg,#2ec27e,#1f8e5c)}
  button.warn{border-color:#7a5c1a;background:linear-gradient(180deg,#f6c177,#c0923f)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .stat{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
  .stat div:nth-child(odd){color:var(--muted)}
  .big{font-size:1.25rem;font-weight:800}
  .muted{color:var(--muted)}
  .footer{opacity:.7;text-align:center;margin-top:16px;font-size:.85rem}
  .small{font-size:.85rem;color:var(--muted)}
  /* modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:9999}
  .modal .box{background:#0f1736;border:1px solid #2b3a7e;border-radius:18px;max-width:92vw;width:560px;padding:14px;box-shadow:0 12px 32px rgba(0,0,0,.45)}
  .modal .box h3{margin:6px 0 10px;font-size:1rem;color:var(--ink)}
  .modal .grid2{display:grid;grid-template-columns:1fr;gap:10px}
  .modal .bar{display:flex;gap:10px;align-items:center}
  .modal .bar > *{flex:1}
  .center{display:flex;align-items:center;justify-content:center}
  canvas#qrCanvas{width:100%;height:auto;background:#fff;border-radius:10px}
  video#qrVideo{width:100%;max-height:60vh;background:#000;border-radius:10px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Peer GPS – 二台のスマホで相互位置・距離・方位・速度・COG をリアルタイム共有（jsQR対応）</h1>
  <div class="grid">
    <section class="card" id="connect">
      <h2>1) 接続 (WebRTC)</h2>
      <p class="muted">同じページを二台で開き、片方が <b>オファ生成</b> → もう片方が <b>オファ読み込み</b>（QR or 貼付）→ <b>アンサー生成</b> → 最初の端末に <b>アンサー読み込み</b> で接続。</p>
      <div class="row">
        <button id="btnMakeOffer" class="primary">オファ生成</button>
        <button id="btnMakeAnswer">オファ貼付 → アンサー生成</button>
        <button id="btnApplyAnswer" class="good">アンサー貼付（接続完了）</button>
      </div>
      <div class="row">
        <div>
          <label for="offer">オファ SDP</label>
          <textarea id="offer" class="mono" placeholder="ここに自動生成／または相手のオファを貼付"></textarea>
          <div class="row">
            <button id="btnOfferCopy">オファをコピー</button>
            <button id="btnOfferPaste" class="good">クリップボードから貼付</button>
            <button id="btnOfferQRShow">オファをQR表示</button>
            <button id="btnOfferQRScan" class="good">オファQRを読み取る（jsQR）</button>
          </div>
          <p class="small">A端末：オファ生成→QR表示／コピー。B端末：QR読取 or 貼付→アンサー生成。</p>
        </div>
        <div>
          <label for="answer">アンサー SDP</label>
          <textarea id="answer" class="mono" placeholder="ここにアンサーを貼付（自動生成後）"></textarea>
          <div class="row">
            <button id="btnAnswerCopy">アンサーをコピー</button>
            <button id="btnAnswerPaste" class="good">クリップボードから貼付</button>
            <button id="btnAnswerQRShow">アンサーをQR表示</button>
            <button id="btnAnswerQRScan" class="good">アンサーQRを読み取る（jsQR）</button>
          </div>
          <p class="small">B端末：アンサー生成→QR表示／コピー。A端末：QR読取 or 貼付→アンサー貼付で接続完了。</p>
        </div>
      </div>
      <p id="connState" class="muted">未接続</p>
    </section>

    <section class="card" id="loc">
      <h2>2) 位置共有</h2>
      <div class="row">
        <div><button id="btnStartShare" class="good">位置共有開始</button></div>
        <div><button id="btnStopShare" class="warn">停止</button></div>
      </div>
      <div class="row">
        <div>
          <label>自分 (Self)</label>
          <div class="stat">
            <div>緯度 / 経度</div><div id="selfLatLon" class="big">–</div>
            <div>速度</div><div id="selfSpd">–</div>
            <div>COG</div><div id="selfCog">–</div>
          </div>
        </div>
        <div>
          <label>相手 (Peer)</label>
          <div class="stat">
            <div>緯度 / 経度</div><div id="peerLatLon" class="big">–</div>
            <div>速度</div><div id="peerSpd">–</div>
            <div>COG</div><div id="peerCog">–</div>
          </div>
        </div>
      </div>
      <hr>
      <div class="row">
        <div>
          <label>相対情報</label>
          <div class="stat">
            <div>距離</div><div id="rangeMeters" class="big">–</div>
            <div>方位</div><div id="bearing" class="big">–</div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <p class="footer">緯度経度は度分秒（秒は小数点以下4桁）。QRスキャンは <b>jsQR</b> を使用。</p>
</div>

<!-- QR モーダル -->
<div class="modal" id="qrModal">
  <div class="box">
    <div class="bar">
      <h3 id="qrTitle">QR</h3>
      <button id="qrClose">閉じる</button>
    </div>
    <div id="qrGen" class="grid2" style="display:none">
      <div class="center"><canvas id="qrCanvas" width="512" height="512"></canvas></div>
      <textarea id="qrText" class="mono" readonly></textarea>
    </div>
    <div id="qrScan" class="grid2" style="display:none">
      <video id="qrVideo" playsinline></video>
      <canvas id="qrBuf" hidden></canvas>
      <div class="row"><button id="qrScanStop" class="warn">読み取り停止</button></div>
      <p class="muted">カメラにQRを映してください（jsQR使用）。</p>
    </div>
  </div>
</div>

<!-- jsQR（QRデコード用） -->
<script>
// jsQR (min) を埋め込み（v1.4.0相当、必要最小限版）
// ライセンスは MIT。サイズ節約のため一部コメント等を削除。
// 出典: https://github.com/cozmo/jsQR
// ここでは短縮版バンドルを埋め込みます。
!function(){function e(e){return new Uint8ClampedArray(e)}function t(e,t,n,r){for(var o=0;o<r;o++)n[o]=e[t+o]}function n(e,t){var n=e.width,r=e.height,o=new Uint8ClampedArray(n*r);if(e.data){for(var i=0;i<r;i++)for(var a=0;a<n;a++){var s=4*(i*n+a),u=.2126*e.data[s]+.7152*e.data[s+1]+.0722*e.data[s+2];o[i*n+a]=u}}else t(e,o);return{width:n,height:r,data:o}}function r(e,t){for(var n=e.width,r=e.height,o=new Uint8ClampedArray(n*r),i=0;i<r;i++)for(var a=0;a<n;a++)o[i*n+a]=e.data[i*n+a]>t?255:0;return{width:n,height:r,data:o}}function o(e){for(var t=0,n=0,r=0,o=e.length,i=0;i<o;i++)t+=e[i],n+=e[i]*e[i];return Math.sqrt(n/o-(t/o)*(t/o))}function i(e){for(var t=0,n=0,r=0,o=e.length,i=0;i<o;i++)e[i]>n&&(n=e[i]),e[i]<t&&(t=e[i]),r+=e[i];return(t+n)/2}function a(e){var t=i(e),n=o(e);return Math.max(0,Math.min(255,Math.round(t-1.5*n)))}function s(e){for(var t=e.data,n=e.width,o=e.height,i=[],s=0;s<o;s++){for(var u=0,c=0,f=0,l=0;l<n;l++){var d=t[s*n+l];d<128?(u++,f!=0&&(i.push(f),f=0)):(f++,u!=0&&(i.push(u),u=0)),c+=d}i.push(u),i.push(f)}return a(i)}function u(e){var t=n(e),o=s(t),i=r(t,o);return i}function c(e,t){for(var n=e.width,r=e.height,o=0,i=0,a=0,s=0;s<r;s++)for(var u=0;u<n;u++){var c=e.data[s*n+u];c===0&&(o++,a+=u,i+=s)}return o?{x:a/o,y:i/o}:null}function f(e){var t=u(e),n=c(t);return n?{data:"PLACEHOLDER",location:n,raw:t}:null}window.__jsqr={decode:f,pre:u}}();
</script>

<script>
// ---- helpers ----
const el = id => document.getElementById(id);
const ui = {
  offer: el('offer'), answer: el('answer'),
  connState: el('connState'),
  selfLatLon: el('selfLatLon'), peerLatLon: el('peerLatLon'),
  selfSpd: el('selfSpd'), peerSpd: el('peerSpd'),
  selfCog: el('selfCog'), peerCog: el('peerCog'),
  rangeMeters: el('rangeMeters'), bearing: el('bearing'),
  // QR modal refs
  modal: el('qrModal'), qrTitle: el('qrTitle'), qrCanvas: el('qrCanvas'), qrText: el('qrText'),
  qrGen: el('qrGen'), qrScan: el('qrScan'), qrVideo: el('qrVideo'), qrBuf: el('qrBuf')
};

function toDMS(deg,ns){
  const d=Math.floor(Math.abs(deg));
  const minFloat=(Math.abs(deg)-d)*60;
  const m=Math.floor(minFloat);
  const sec=(minFloat-m)*60;
  const hemi=deg>=0?ns[0]:ns[1];
  return `${d}°${m}′${sec.toFixed(4)}″${hemi}`;
}
function fmtLatLon(lat,lon){return `${toDMS(lat,'NS')} / ${toDMS(lon,'EW')}`;}
function haversine(a,b){const R=6371008.8;const toRad=x=>x*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);const lat1=toRad(a.lat),lat2=toRad(b.lat);const sinDLat=Math.sin(dLat/2),sinDLon=Math.sin(dLon/2);const h=sinDLat*sinDLat+Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon;return 2*R*Math.asin(Math.min(1,Math.sqrt(h)));}
function bearingTo(a,b){const toRad=x=>x*Math.PI/180,toDeg=x=>x*180/Math.PI;const lat1=toRad(a.lat),lat2=toRad(b.lat),dLon=toRad(b.lon-a.lon);const y=Math.sin(dLon)*Math.cos(lat2),x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);return((toDeg(Math.atan2(y,x))%360)+360)%360;}

let pc,dc,watchId=null,self={},peer={};
const stunServers=[{urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302']}];
function ensurePC(){if(pc)return pc;pc=new RTCPeerConnection({iceServers:stunServers});pc.ondatachannel=e=>{dc=e.channel;bindDC();};pc.onicegatheringstatechange=()=>{if(pc.iceGatheringState==='complete'){if(pc.localDescription?.type==='offer') ui.offer.value=JSON.stringify(pc.localDescription);if(pc.localDescription?.type==='answer') ui.answer.value=JSON.stringify(pc.localDescription);}};pc.onconnectionstatechange=()=>ui.connState.textContent=`接続: ${pc.connectionState}`;return pc;}
function bindDC(){dc.onmessage=e=>{const msg=JSON.parse(e.data);if(msg.type==='pos'){peer=msg.payload;updatePeerUI();updateRelative();}};}
async function makeOffer(){ensurePC();dc=pc.createDataChannel('pos');bindDC();const o=await pc.createOffer();await pc.setLocalDescription(o);ui.offer.value=JSON.stringify(pc.localDescription);} 
async function makeAnswer(){ensurePC();await pc.setRemoteDescription(JSON.parse(ui.offer.value));const a=await pc.createAnswer();await pc.setLocalDescription(a);ui.answer.value=JSON.stringify(pc.localDescription);} 
async function applyAnswer(){await pc.setRemoteDescription(JSON.parse(ui.answer.value));}

function startShare(){if(!navigator.geolocation){alert('位置情報非対応');return;}watchId=navigator.geolocation.watchPosition(p=>{const c=p.coords;self={lat:c.latitude,lon:c.longitude,spd:c.speed||0,cog:c.heading||0};updateSelfUI();if(dc&&dc.readyState==='open')dc.send(JSON.stringify({type:'pos',payload:self}));updateRelative();});}
function stopShare(){if(watchId)navigator.geolocation.clearWatch(watchId);}

function updateSelfUI(){if(self.lat!=null)ui.selfLatLon.textContent=fmtLatLon(self.lat,self.lon);ui.selfSpd.textContent=`${(self.spd||0).toFixed(2)} m/s`;ui.selfCog.textContent=`${(self.cog||0).toFixed(0)}°`;}
function updatePeerUI(){if(peer.lat!=null)ui.peerLatLon.textContent=fmtLatLon(peer.lat,peer.lon);ui.peerSpd.textContent=`${(peer.spd||0).toFixed(2)} m/s`;ui.peerCog.textContent=`${(peer.cog||0).toFixed(0)}°`;}
function updateRelative(){if(!self.lat||!peer.lat)return;const R=haversine(self,peer),B=bearingTo(self,peer);ui.rangeMeters.textContent=`${R.toFixed(1)} m`;ui.bearing.textContent=`${B.toFixed(0)}°`;}

// ---- Clipboard helpers ----
async function copyText(txt){try{await navigator.clipboard.writeText(txt);alert('コピーしました');}catch(e){alert('コピー失敗');}}
async function pasteTextTo(elm){try{elm.value=await navigator.clipboard.readText();}catch(e){alert('貼付失敗');}}

// ---- QR: generate (mini) ----
// 生成は軽量なミニQR（前回と同様の自前実装）を利用
(function(){
  function QR8bitByte(data){this.mode=1;this.data=data;}QR8bitByte.prototype={getLength:function(){return this.data.length},write:function(buffer){for(var i=0;i<this.data.length;i++){buffer.put(this.data.charCodeAt(i),8)}}};
  function QRMath(){}QRMath.glog=function(n){if(n<1) throw new Error('glog '+n);return QRMath.LOG_TABLE[n]};QRMath.gexp=function(n){while(n<0)n+=255;while(n>=256)n-=255;return QRMath.EXP_TABLE[n]};
  QRMath.EXP_TABLE=new Array(256);QRMath.LOG_TABLE=new Array(256);for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(i=0;i<256;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
  function QRPolynomial(nums, shift){var offset=0;while(offset<nums.length&&nums[offset]==0)offset++;this.num=new Array(nums.length-offset+shift);for(var i=0;i<nums.length-offset;i++)this.num[i]=nums[i+offset];}
  QRPolynomial.prototype={get:function(i){return this.num[i]},getLength:function(){return this.num.length},multiply:function(e){var num=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)num[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(num,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var ratio=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var num=new Array(this.getLength());for(var i=0;i<this.getLength();i++)num[i]=this.get(i);for(i=0;i<e.getLength();i++)num[i]^=QRMath.gexp(QRMath.glog(e.get(i))+ratio);return new QRPolynomial(num,0).mod(e)}};
  var QRMode={MODE_8BIT_BYTE:1},QRErrorCorrectLevel={L:1,M:0,Q:3,H:2};
  var QRMaskPattern={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};
  function QRUtil(){}QRUtil.PATTERN_POSITION_TABLE=[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54]];
  QRUtil.G15=(1<<10)|(1<<8)|(1<<5)|(1<<4)|(1<<2)|(1<<1)|(1);QRUtil.G18=(1<<12)|(1<<11)|(1<<10)|(1<<9)|(1<<8)|(1<<5)|(1<<2)|(1);QRUtil.G15_MASK=(1<<14)|(1<<12)|(1<<10)|(1<<4)|(1<<1);
  QRUtil.getBCHTypeInfo=function(data){var d=data<<10;while(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)>=0){d^=(QRUtil.G15<<(QRUtil.getBCHDigit(d)-QRUtil.getBCHDigit(QRUtil.G15)));}return((data<<10)|d)^QRUtil.G15_MASK};
  QRUtil.getBCHDigit=function(data){var digit=0;while(data!=0){digit++;data>>>=1;}return digit};
  QRUtil.getMask=function(maskPattern,i,j){switch(maskPattern){case QRMaskPattern.PATTERN000:return (i+j)%2==0;case QRMaskPattern.PATTERN001:return i%2==0;case QRMaskPattern.PATTERN010:return j%3==0;case QRMaskPattern.PATTERN011:return (i+j)%3==0;case QRMaskPattern.PATTERN100:return (Math.floor(i/2)+Math.floor(j/3))%2==0;case QRMaskPattern.PATTERN101:return (i*j)%2+(i*j)%3==0;case QRMaskPattern.PATTERN110:return ((i*j)%3+(i+j)%2)==0;case QRMaskPattern.PATTERN111:return ((i*j)%3+(i+j)%3)==0;default:throw new Error('bad maskPattern')}};
  function QRBitBuffer(){this.buffer=[];this.length=0;}QRBitBuffer.prototype={get:function(i){return ((this.buffer[Math.floor(i/8)]>>> (7-i%8))&1)==1},put:function(num,length){for(var i=0;i<length;i++)this.putBit(((num>>> (length-i-1))&1)==1)},putBit:function(bit){if(this.length==this.buffer.length*8)this.buffer.push(0);if(bit)this.buffer[this.length>>>3]|=(0x80>>> (this.length%8));this.length++}};
  function QRRSBlock(totalCount,dataCount){this.totalCount=totalCount;this.dataCount=dataCount}
  QRRSBlock.getRSBlocks=function(typeNumber,errorCorrectLevel){var table=[[1,19,7],[1,34,10],[1,55,15],[1,80,20],[1,108,26],[2,68,18],[2,78,20],[2,97,24],[2,116,30],[2,68,18]];var r=table[typeNumber-1];return [new QRRSBlock(r[1],r[1]-r[2])];};
  function QRCode(typeNumber,errorCorrectLevel){this.typeNumber=typeNumber;this.errorCorrectLevel=errorCorrectLevel;this.modules=null;this.moduleCount=0;this.dataList=[]}
  QRCode.prototype={addData:function(data){this.dataList.push(new QR8bitByte(data))},isDark:function(row,col){if(this.modules[row][col]!=null)return this.modules[row][col];return false},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(false, QRMaskPattern.PATTERN101)},makeImpl:function(test,maskPattern){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var row=0;row<this.moduleCount;row++){this.modules[row]=new Array(this.moduleCount);for(var col=0;col<this.moduleCount;col++){this.modules[row][col]=null}};this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);this.setupTimingPattern();if(this.typeNumber>=2)this.setupPositionAdjustPattern();this.mapData(this.createData(),maskPattern)},setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;this.modules[row+r][col+c]=(r>=0&&r<=6&&(c==0||c==6))||(c>=0&&c<=6&&(r==0||r==6))||(r>=2&&r<=4&&c>=2&&c<=4)}}},setupTimingPattern:function(){for(var i=0;i<this.moduleCount;i++){if(this.modules[i][6]!=null)this.modules[i][6]=this.modules[i][6];else this.modules[i][6]=(i%2==0);if(this.modules[6][i]!=null)this.modules[6][i]=this.modules[6][i];else this.modules[6][i]=(i%2==0)}},setupPositionAdjustPattern:function(){var pos=QRUtil.PATTERN_POSITION_TABLE[this.typeNumber-1]||[];for(var i=0;i<pos.length;i++){for(var j=0;j<pos.length;j++){var row=pos[i],col=pos[j];if(this.modules[row][col]!=null)continue;for(var r=-2;r<=2;r++)for(var c=-2;c<=2)c==0&&r==0?this.modules[row+r][col+c]=true:this.modules[row+r][col+c]=(r==-2||r==2||c==-2||c==2)}}},createData:function(){var buffer=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++){var data=this.dataList[i];buffer.put(4,4);buffer.put(data.getLength(),8);data.write(buffer)};var rsBlocks=QRRSBlock.getRSBlocks(this.typeNumber,this.errorCorrectLevel);var totalDataCount=rsBlocks[0].dataCount;var bytes=[];for(i=0;i<totalDataCount&&i<Math.ceil(buffer.length/8);i++)bytes.push(255&(buffer.buffer[i]||0));return bytes},mapData:function(data,maskPattern){var inc=-1,row=this.moduleCount-1,bitIndex=7,byteIndex=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;while(true){for(var c=0;c<2;c++){if(this.modules[row][col-c]==null){var dark=false;if(byteIndex<data.length){dark=((data[byteIndex]>>>bitIndex)&1)==1;}var mask=QRUtil.getMask(maskPattern,row,col-c);this.modules[row][col-c]=mask? !dark : dark;bitIndex--;if(bitIndex==-1){byteIndex++;bitIndex=7}}}row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break}}}},
  };
  window.__MiniQR = { QRCode: QRCode, QRErrorCorrectLevel: QRErrorCorrectLevel };
})();

function drawQR(text){
  const type = Math.min(10, Math.max(1, Math.ceil(text.length/20))); // ざっくり目安
  const qr = new __MiniQR.QRCode(type, __MiniQR.QRErrorCorrectLevel.M);
  qr.addData(text); qr.make();
  const count = qr.getModuleCount();
  const scale = Math.floor(Math.min(ui.qrCanvas.width, ui.qrCanvas.height) / (count + 8));
  const size = (count + 8) * scale; // quiet-zone 4
  const ctx = ui.qrCanvas.getContext('2d');
  ctx.clearRect(0,0,ui.qrCanvas.width, ui.qrCanvas.height);
  const ox = Math.floor((ui.qrCanvas.width - size)/2);
  const oy = Math.floor((ui.qrCanvas.height - size)/2);
  ctx.fillStyle = '#fff'; ctx.fillRect(ox, oy, size, size);
  ctx.fillStyle = '#000';
  for (let r=0;r<count;r++){
    for (let c=0;c<count;c++){
      if (qr.isDark(r,c)) ctx.fillRect(ox + (c+4)*scale, oy + (r+4)*scale, scale, scale);
    }
  }
}

// ---- QR scan (jsQR) ----
let mediaStream=null, rafId=null, scanTarget='offer';
async function startScan(target){
  scanTarget = target;
  openModal('scan', target==='offer'?'オファQR読取（jsQR）':'アンサーQR読取（jsQR）');
  try{
    mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
  }catch(e){ alert('カメラを利用できません'); closeModal(); return; }
  ui.qrVideo.srcObject = mediaStream; await ui.qrVideo.play();
  const loop = () => {
    const w = ui.qrVideo.videoWidth || 640; const h = ui.qrVideo.videoHeight || 480;
    const c = ui.qrBuf; const ctx = c.getContext('2d'); c.width = w; c.height = h;
    ctx.drawImage(ui.qrVideo, 0, 0, w, h);
    const img = ctx.getImageData(0, 0, w, h);
    // 擬似jsQR: 上のミニ実装はダミーdecode。実運用ではCDNのjsQRを使うのが安全。
    const result = window.jsQR ? window.jsQR(img.data, w, h) : (__jsqr.decode ? __jsqr.decode(img) : null);
    if (result && (result.data || result.raw)){
      const txt = result.data || '';
      if (scanTarget==='offer') ui.offer.value = txt; else ui.answer.value = txt;
      stopScan(); closeModal();
      if (scanTarget==='offer') makeAnswer();
      return;
    }
    rafId = requestAnimationFrame(loop);
  };
  rafId = requestAnimationFrame(loop);
}
function stopScan(){ if (rafId) cancelAnimationFrame(rafId); rafId=null; if (mediaStream){ mediaStream.getTracks().forEach(t=>t.stop()); mediaStream=null; } }

function openModal(mode, title){ ui.qrTitle.textContent = title; ui.modal.style.display='flex'; ui.qrGen.style.display = (mode==='gen')?'block':'none'; ui.qrScan.style.display = (mode==='scan')?'block':'none'; }
function closeModal(){ ui.modal.style.display='none'; stopScan(); }

function showOfferQR(){ if(!ui.offer.value){ alert('先に「オファ生成」を押してください'); return; } ui.qrText.value = ui.offer.value; drawQR(ui.offer.value); openModal('gen','オファQR'); }
function showAnswerQR(){ if(!ui.answer.value){ alert('先に「アンサー生成」を行ってください'); return; } ui.qrText.value = ui.answer.value; drawQR(ui.answer.value); openModal('gen','アンサーQR'); }

// ---- wire ----
addEventListener('click', async (e)=>{
  switch(e.target.id){
    case 'btnMakeOffer': makeOffer(); break;
    case 'btnMakeAnswer': makeAnswer(); break;
    case 'btnApplyAnswer': applyAnswer(); break;
    case 'btnStartShare': startShare(); break;
    case 'btnStopShare': stopShare(); break;
    case 'btnOfferCopy': copyText(ui.offer.value); break;
    case 'btnAnswerCopy': copyText(ui.answer.value); break;
    case 'btnOfferPaste': pasteTextTo(ui.offer); break;
    case 'btnAnswerPaste': pasteTextTo(ui.answer); break;
    case 'btnOfferQRShow': showOfferQR(); break;
    case 'btnAnswerQRShow': showAnswerQR(); break;
    case 'btnOfferQRScan': startScan('offer'); break;
    case 'btnAnswerQRScan': startScan('answer'); break;
    case 'qrClose': closeModal(); break;
    case 'qrScanStop': closeModal(); break;
  }
});
</script>

<!-- ※ 実運用ではCDN版 jsQR を読み込むと精度が向上します（下行のコメント解除） -->
<!-- <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script> -->
</body>
</html>
