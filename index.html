<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>相互位置共有（距離・方位・速度・COG）</title>
<style>
  :root{
    --bg:#0b1020; --panel:#111933; --card:#0f1730; --fg:#eaf1ff; --muted:#9fb2d8; --acc:#69a8ff; --ok:#2ec27e; --warn:#f6c177; --bad:#ff6b6b;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:15px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  h1{font-size:1.25rem;margin:0 0 8px}
  .grid{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:960px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--card);border:1px solid #1a2448;border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;align-items:center}
  .kvs b{opacity:.9}
  .small{font-size:.82rem;color:var(--muted)}
  code.badge{background:#1a2858;color:#cfe1ff;padding:2px 6px;border-radius:7px;border:1px solid #25407a}
  button{background:var(--acc);color:#072046;border:0;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer}
  button.ghost{background:transparent;border:1px solid #335cac;color:#cfe1ff}
  button:disabled{opacity:.5;cursor:not-allowed}
  textarea,input,select{width:100%;background:#0a1230;color:#eaf1ff;border:1px solid #1a2b55;border-radius:10px;padding:10px}
  textarea{min-height:120px;resize:vertical}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#12214a;border:1px solid #203b76;border-radius:999px;padding:4px 10px}
  .muted{color:var(--muted)}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .sep{height:1px;background:#1b274c;margin:10px 0}
  .status{display:flex;gap:8px;flex-wrap:wrap}
  .blink{animation:blink 1.2s linear infinite}
  @keyframes blink{50%{opacity:.45}}
</style>
</head>
<body>
<div class="wrap">
  <h1>２台のスマホで相互の <code class="badge">緯度経度（度分秒・秒4桁）</code>／<code class="badge">距離(m)</code>／<code class="badge">相手の方位(0–360°)</code>／<code class="badge">速度(knot, km/h)</code>／<code class="badge">COG</code> を共有</h1>
  <div class="grid">
    <section class="card">
      <div class="status">
        <span class="pill">GPS: <span id="gpsStatus" class="muted">未開始</span></span>
        <span class="pill">WebRTC: <span id="rtcStatus" class="muted">未接続</span></span>
        <span class="pill">通信: <span id="rxTx" class="muted">—</span></span>
      </div>
      <div class="sep"></div>
      <div class="grid-2">
        <div>
          <h3>あなた（Local）</h3>
          <div class="kvs small">
            <b>緯度:</b><span id="myLat">—</span>
            <b>経度:</b><span id="myLon">—</span>
            <b>速度:</b><span id="mySpeed">—</span>
            <b>COG:</b><span id="myCOG">—</span>
            <b>Fix時刻:</b><span id="myFixTime" class="muted">—</span>
          </div>
        </div>
        <div>
          <h3>相手（Remote）</h3>
          <div class="kvs small">
            <b>緯度:</b><span id="peerLat">—</span>
            <b>経度:</b><span id="peerLon">—</span>
            <b>速度:</b><span id="peerSpeed">—</span>
            <b>COG:</b><span id="peerCOG">—</span>
            <b>受信Fix時刻:</b><span id="peerFixTime" class="muted">—</span>
          </div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="grid-3">
        <div class="card" style="background:#0c1636">
          <div class="kvs">
            <b>お互いの距離:</b><span id="dist">—</span>
            <b>相手の方位:</b><span id="bearing">—</span>
          </div>
        </div>
        <div class="card" style="background:#0c1636">
          <div class="kvs">
            <b>最終送信:</b><span id="txTime" class="small muted">—</span>
            <b>最終受信:</b><span id="rxTime" class="small muted">—</span>
          </div>
        </div>
        <div class="card" style="background:#0c1636">
          <div class="kvs">
            <b>位置精度:</b><span id="accuracy" class="small">—</span>
            <b>高度:</b><span id="altitude" class="small">—</span>
          </div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="right">
        <button id="startGPS">GPSを開始</button>
        <button id="stopGPS" class="ghost">GPS停止</button>
      </div>
    </section>

    <section class="card">
      <h3>シグナリング（SDPコピー＆貼り付け）</h3>
      <p class="small">どちらかが「オファー作成」を押してSDPをコピー→もう一方が貼り付けて「リモート設定＆アンサー作成」。最後に最初の人がアンサーを貼り付けて「リモート設定」。</p>
      <div class="grid-2">
        <div>
          <label class="small">ローカルSDP</label>
          <textarea id="localSDP" class="mono" readonly></textarea>
          <div class="right">
            <button id="makeOffer">オファー作成</button>
            <button id="copyLocal" class="ghost">コピー</button>
          </div>
        </div>
        <div>
          <label class="small">リモートSDP（貼り付け）</label>
          <textarea id="remoteSDP" class="mono"></textarea>
          <div class="right">
            <button id="setRemote">リモート設定</button>
            <button id="makeAnswer" class="ghost">リモートがオファー → アンサー作成</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
// ===================== ユーティリティ =====================
const el = id => document.getElementById(id);
const fmtTime = t => new Date(t).toLocaleString();

function toDMS(deg, isLat){
  const dir = isLat ? (deg>=0? 'N':'S') : (deg>=0? 'E':'W');
  const a = Math.abs(deg);
  const d = Math.floor(a);
  const mFloat = (a - d) * 60;
  const m = Math.floor(mFloat);
  const s = (mFloat - m) * 60;
  // 秒は小数点以下4桁
  const sStr = s.toFixed(4).padStart(2+1+4,'0');
  return `${dir} ${d}° ${String(m).padStart(2,'0')}' ${sStr}"`;
}

function haversine(p1, p2){
  const R = 6371000; // meters
  const toRad = x => x * Math.PI/180;
  const dLat = toRad(p2.lat - p1.lat);
  const dLon = toRad(p2.lon - p1.lon);
  const lat1 = toRad(p1.lat), lat2 = toRad(p2.lat);
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function initialBearing(p1, p2){
  const toRad = x => x*Math.PI/180; const toDeg = x => x*180/Math.PI;
  const φ1 = toRad(p1.lat), φ2 = toRad(p2.lat);
  const λ1 = toRad(p1.lon), λ2 = toRad(p2.lon);
  const y = Math.sin(λ2-λ1) * Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
  let brng = toDeg(Math.atan2(y,x));
  return (brng + 360) % 360; // 0-360
}

function mpsToKnots(mps){ return mps * 1.943844; }
function mpsToKmh(mps){ return mps * 3.6; }

// 移動方向推定（過去2点からCOG）
function courseOverGround(prev, cur){
  if(!prev || !cur) return null;
  return initialBearing(prev, cur);
}

// ===================== 状態 =====================
let myFix = null;      // {lat, lon, speed_mps, cog, ts, accuracy, alt}
let myPrevFix = null;
let peerFix = null;    // 受信した相手位置
let watchId = null;

// ===================== UI 更新 =====================
function updateUI(){
  // Local
  if(myFix){
    el('myLat').textContent = toDMS(myFix.lat,true);
    el('myLon').textContent = toDMS(myFix.lon,false);
    const k = myFix.speed_mps!=null? mpsToKnots(myFix.speed_mps).toFixed(2)+" kn" : '—';
    const h = myFix.speed_mps!=null? mpsToKmh(myFix.speed_mps).toFixed(1)+" km/h" : '';
    el('mySpeed').textContent = (k==='—')? '—' : `${k} (${h})`;
    el('myCOG').textContent = (myFix.cog!=null)? `${myFix.cog.toFixed(0)}°` : '—';
    el('myFixTime').textContent = fmtTime(myFix.ts);
    el('accuracy').textContent = (myFix.accuracy!=null? `${Math.round(myFix.accuracy)} m` : '—');
    el('altitude').textContent = (myFix.alt!=null? `${Math.round(myFix.alt)} m` : '—');
  }
  // Peer
  if(peerFix){
    el('peerLat').textContent = toDMS(peerFix.lat,true);
    el('peerLon').textContent = toDMS(peerFix.lon,false);
    const k = peerFix.speed_mps!=null? mpsToKnots(peerFix.speed_mps).toFixed(2)+" kn" : '—';
    const h = peerFix.speed_mps!=null? mpsToKmh(peerFix.speed_mps).toFixed(1)+" km/h" : '';
    el('peerSpeed').textContent = (k==='—')? '—' : `${k} (${h})`;
    el('peerCOG').textContent = (peerFix.cog!=null)? `${peerFix.cog.toFixed(0)}°` : '—';
    el('peerFixTime').textContent = fmtTime(peerFix.ts);
  }
  // Distance & Bearing
  if(myFix && peerFix){
    const d = haversine(myFix, peerFix);
    el('dist').textContent = `${d.toFixed(d<1000?0:1)} m`;
    const brg = initialBearing(myFix, peerFix);
    el('bearing').textContent = `${brg.toFixed(0)}°`;
  }
}

// ===================== Geolocation =====================
function startGPS(){
  if(!('geolocation' in navigator)){
    el('gpsStatus').textContent = '未対応';
    return;
  }
  el('gpsStatus').textContent = '取得中…';
  watchId = navigator.geolocation.watchPosition(pos=>{
    const c = pos.coords;
    myPrevFix = myFix;
    let cog = (c.heading!=null && !Number.isNaN(c.heading)) ? c.heading : null;
    // 端末がheadingを出さない場合は移動ベクトルから算出
    if(cog==null && myPrevFix){
      const est = courseOverGround(myPrevFix, {lat:c.latitude, lon:c.longitude});
      if(est!=null) cog = est;
    }
    myFix = {
      lat: c.latitude,
      lon: c.longitude,
      speed_mps: (c.speed!=null && !Number.isNaN(c.speed))? c.speed : null,
      cog: (cog!=null && !Number.isNaN(cog))? ((cog%360)+360)%360 : null,
      ts: pos.timestamp,
      accuracy: c.accuracy ?? null,
      alt: (c.altitude!=null && !Number.isNaN(c.altitude))? c.altitude : null,
    };
    el('gpsStatus').textContent = '受信中';
    sendState();
    el('txTime').textContent = fmtTime(Date.now());
    updateUI();
  }, err=>{
    el('gpsStatus').textContent = 'エラー: '+err.message;
  },{
    enableHighAccuracy:true, maximumAge: 500, timeout: 15000
  });
}
function stopGPS(){
  if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  el('gpsStatus').textContent = '停止中';
}

// ===================== WebRTC（手動SDP） =====================
let pc, dc;

function ensurePC(){
  if(pc) return pc;
  pc = new RTCPeerConnection({
    iceServers:[{urls:["stun:stun.l.google.com:19302"]}]
  });
  pc.oniceconnectionstatechange = ()=>{
    el('rtcStatus').textContent = pc.iceConnectionState;
  };
  pc.onicecandidate = async (ev)=>{
    if(!ev.candidate){ // ICE収集完了
      el('localSDP').value = JSON.stringify(pc.localDescription);
    }
  };
  pc.ondatachannel = (ev)=>{
    dc = ev.channel;
    wireDC();
  };
  return pc;
}

function wireDC(){
  if(!dc) return;
  dc.onopen = ()=>{ el('rtcStatus').textContent = '接続中'; };
  dc.onclose = ()=>{ el('rtcStatus').textContent = '切断'; };
  dc.onmessage = (ev)=>{
    el('rxTx').textContent = '↓受信';
    const msg = JSON.parse(ev.data);
    if(msg.type==='fix'){
      peerFix = msg.payload;
      el('rxTime').textContent = fmtTime(Date.now());
      updateUI();
    }
  };
}

async function makeOffer(){
  ensurePC();
  dc = pc.createDataChannel('pos');
  wireDC();
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  el('localSDP').value = 'ICE収集中…少し待ってからコピーしてください';
}

async function setRemote(){
  ensurePC();
  const txt = el('remoteSDP').value.trim();
  if(!txt) return alert('リモートSDPを貼り付けてください');
  let desc; try{ desc = JSON.parse(txt);}catch(e){ return alert('JSONではありません'); }
  await pc.setRemoteDescription(desc);
}

async function makeAnswer(){
  ensurePC();
  if(!pc.remoteDescription) return alert('先に相手のオファーSDPを貼り付けてください');
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  el('localSDP').value = 'ICE収集中…少し待ってからコピーしてください';
}

function copyLocal(){
  const v = el('localSDP').value;
  if(!v || v.startsWith('ICE収集中')) return alert('ICE収集が終わってからコピーしてください');
  navigator.clipboard.writeText(v).then(()=>{
    alert('ローカルSDPをコピーしました');
  });
}

function sendState(){
  if(dc && dc.readyState==='open' && myFix){
    el('rxTx').textContent = '↑送信';
    dc.send(JSON.stringify({type:'fix', payload: myFix}));
  }
}

// ===================== イベント配線 =====================
el('startGPS').onclick = startGPS;
el('stopGPS').onclick = stopGPS;
el('makeOffer').onclick = makeOffer;
el('copyLocal').onclick = copyLocal;
el('setRemote').onclick = setRemote;
el('makeAnswer').onclick = makeAnswer;

// ペースト補助（ダブルクリックで全選択）
['remoteSDP','localSDP'].forEach(id=>{
  el(id).ondblclick = (e)=>{ e.target.select(); };
});

</script>
</body>
</html>
