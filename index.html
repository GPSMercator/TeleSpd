<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Peer GPS (2 phones)</title>
<style>
  :root{--bg:#0b1020;--panel:#131a33;--ink:#e8eefc;--muted:#9fb2d8;--accent:#5aa9ff;--good:#2ec27e;--warn:#f6c177;--bad:#ff6b6b}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:15px/1.4 system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Noto Sans JP",sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{font-size:1.2rem;margin:4px 0 12px}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width:860px){.grid{grid-template-columns:1.1fr .9fr}}
  .card{background:var(--panel);border-radius:16px;box-shadow:0 8px 28px rgba(0,0,0,.25);padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{flex:1}
  label{font-weight:600;color:var(--muted);font-size:.9rem}
  input,textarea,button,select{width:100%;box-sizing:border-box;background:#0e1530;color:var(--ink);border:1px solid #26315e;border-radius:10px;padding:10px 12px}
  textarea{min-height:120px;resize:vertical}
  button{cursor:pointer;border:1px solid #3a4ea3;background:linear-gradient(180deg,#1a2560,#141d49);font-weight:700}
  button.primary{background:linear-gradient(180deg,#3170ff,#2651cc)}
  button.good{border-color:#1e5e3a;background:linear-gradient(180deg,#2ec27e,#1f8e5c)}
  button.warn{border-color:#7a5c1a;background:linear-gradient(180deg,#f6c177,#c0923f)}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .stat{display:grid;grid-template-columns:auto 1fr;gap:6px 10px}
  .stat div:nth-child(odd){color:var(--muted)}
  .big{font-size:1.25rem;font-weight:800}
  .muted{color:var(--muted)}
  .footer{opacity:.7;text-align:center;margin-top:16px;font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>Peer GPS – 二台のスマホで相互位置・距離・方位・速度・COG をリアルタイム共有</h1>
  <div class="grid">
    <section class="card" id="connect">
      <h2>1) 接続 (WebRTC)</h2>
      <div class="row">
        <button id="btnMakeOffer" class="primary">オファ生成</button>
        <button id="btnMakeAnswer">オファ貼付 → アンサー生成</button>
        <button id="btnApplyAnswer" class="good">アンサー貼付（接続完了）</button>
      </div>
      <div class="row">
        <div>
          <label for="offer">オファ SDP</label>
          <textarea id="offer" class="mono" placeholder="ここに自動生成／または相手のオファを貼付"></textarea>
          <div class="row">
            <button id="btnOfferCopy">オファをコピー</button>
            <button id="btnOfferPaste" class="good">クリップボードから貼付</button>
          </div>
        </div>
        <div>
          <label for="answer">アンサー SDP</label>
          <textarea id="answer" class="mono" placeholder="ここにアンサーを貼付（自動生成後）"></textarea>
          <div class="row">
            <button id="btnAnswerCopy">アンサーをコピー</button>
            <button id="btnAnswerPaste" class="good">クリップボードから貼付</button>
          </div>
        </div>
      </div>
      <p id="connState" class="muted">未接続</p>
    </section>

    <section class="card" id="loc">
      <h2>2) 位置共有</h2>
      <div class="row">
        <div><button id="btnStartShare" class="good">位置共有開始</button></div>
        <div><button id="btnStopShare" class="warn">停止</button></div>
      </div>
      <div class="row">
        <div>
          <label>自分 (Self)</label>
          <div class="stat">
            <div>緯度 / 経度</div><div id="selfLatLon" class="big">–</div>
            <div>速度</div><div id="selfSpd">–</div>
            <div>COG</div><div id="selfCog">–</div>
          </div>
        </div>
        <div>
          <label>相手 (Peer)</label>
          <div class="stat">
            <div>緯度 / 経度</div><div id="peerLatLon" class="big">–</div>
            <div>速度</div><div id="peerSpd">–</div>
            <div>COG</div><div id="peerCog">–</div>
          </div>
        </div>
      </div>
      <hr>
      <div class="row">
        <div>
          <label>相対情報</label>
          <div class="stat">
            <div>距離</div><div id="rangeMeters" class="big">–</div>
            <div>方位</div><div id="bearing" class="big">–</div>
          </div>
        </div>
      </div>
    </section>
  </div>
  <p class="footer">緯度経度は度分秒表示（秒は小数点以下4桁）。</p>
</div>

<script>
const el = id => document.getElementById(id);
const ui = {
  offer: el('offer'), answer: el('answer'),
  connState: el('connState'), dcState: el('dcState'),
  selfLatLon: el('selfLatLon'), peerLatLon: el('peerLatLon'),
  selfSpd: el('selfSpd'), peerSpd: el('peerSpd'),
  selfCog: el('selfCog'), peerCog: el('peerCog'),
  rangeMeters: el('rangeMeters'), bearing: el('bearing')
};

function toDMS(deg,ns){
  const d=Math.floor(Math.abs(deg));
  const minFloat=(Math.abs(deg)-d)*60;
  const m=Math.floor(minFloat);
  const sec=(minFloat-m)*60;
  const hemi=deg>=0?ns[0]:ns[1];
  return `${d}°${m}′${sec.toFixed(4)}″${hemi}`;
}
function fmtLatLon(lat,lon){return `${toDMS(lat,'NS')} / ${toDMS(lon,'EW')}`;}

function haversine(a,b){const R=6371008.8;const toRad=x=>x*Math.PI/180;const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);const lat1=toRad(a.lat),lat2=toRad(b.lat);const sinDLat=Math.sin(dLat/2),sinDLon=Math.sin(dLon/2);const h=sinDLat*sinDLat+Math.cos(lat1)*Math.cos(lat2)*sinDLon*sinDLon;return 2*R*Math.asin(Math.min(1,Math.sqrt(h)));}
function bearingTo(a,b){const toRad=x=>x*Math.PI/180,toDeg=x=>x*180/Math.PI;const lat1=toRad(a.lat),lat2=toRad(b.lat),dLon=toRad(b.lon-a.lon);const y=Math.sin(dLon)*Math.cos(lat2),x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);return((toDeg(Math.atan2(y,x))%360)+360)%360;}

let pc,dc,watchId=null,self={},peer={};
const stunServers=[{urls:['stun:stun.l.google.com:19302']}];
function ensurePC(){if(pc)return pc;pc=new RTCPeerConnection({iceServers:stunServers});pc.ondatachannel=e=>{dc=e.channel;bindDC();};return pc;}
function bindDC(){dc.onmessage=e=>{const msg=JSON.parse(e.data);if(msg.type==='pos'){peer=msg.payload;updatePeerUI();updateRelative();}};}
async function makeOffer(){ensurePC();dc=pc.createDataChannel('pos');bindDC();const o=await pc.createOffer();await pc.setLocalDescription(o);ui.offer.value=JSON.stringify(pc.localDescription);}
async function makeAnswer(){ensurePC();await pc.setRemoteDescription(JSON.parse(ui.offer.value));const a=await pc.createAnswer();await pc.setLocalDescription(a);ui.answer.value=JSON.stringify(pc.localDescription);}
async function applyAnswer(){await pc.setRemoteDescription(JSON.parse(ui.answer.value));}

function startShare(){if(!navigator.geolocation){alert('位置情報非対応');return;}watchId=navigator.geolocation.watchPosition(p=>{const c=p.coords;self={lat:c.latitude,lon:c.longitude,spd:c.speed||0,cog:c.heading||0};updateSelfUI();if(dc&&dc.readyState==='open')dc.send(JSON.stringify({type:'pos',payload:self}));updateRelative();});}
function stopShare(){if(watchId)navigator.geolocation.clearWatch(watchId);}

function updateSelfUI(){if(self.lat)ui.selfLatLon.textContent=fmtLatLon(self.lat,self.lon);ui.selfSpd.textContent=`${(self.spd||0).toFixed(2)} m/s`;ui.selfCog.textContent=`${(self.cog||0).toFixed(0)}°`;}
function updatePeerUI(){if(peer.lat)ui.peerLatLon.textContent=fmtLatLon(peer.lat,peer.lon);ui.peerSpd.textContent=`${(peer.spd||0).toFixed(2)} m/s`;ui.peerCog.textContent=`${(peer.cog||0).toFixed(0)}°`;}
function updateRelative(){if(!self.lat||!peer.lat)return;const R=haversine(self,peer),B=bearingTo(self,peer);ui.rangeMeters.textContent=`${R.toFixed(1)} m`;ui.bearing.textContent=`${B.toFixed(0)}°`;}

document.addEventListener('click',e=>{switch(e.target.id){case'btnMakeOffer':makeOffer();break;case'btnMakeAnswer':makeAnswer();break;case'btnApplyAnswer':applyAnswer();break;case'btnStartShare':startShare();break;case'btnStopShare':stopShare();break;case'btnOfferCopy':navigator.clipboard.writeText(ui.offer.value);break;case'btnAnswerCopy':navigator.clipboard.writeText(ui.answer.value);break;case'btnOfferPaste':navigator.clipboard.readText().then(t=>ui.offer.value=t);break;case'btnAnswerPaste':navigator.clipboard.readText().then(t=>ui.answer.value=t);break;}});
</script>
</body>
</html>
