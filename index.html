<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2台のスマホ位置共有＆方位計算</title>
  <style>
    :root {
      --bg: #050814;
      --card: #101628;
      --fg: #f4f7ff;
      --muted: #9fb2d8;
      --accent: #5aa9ff;
      --danger: #ff6b6b;
      --good: #2ec27e;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top, #17233f 0, #050814 55%);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", "Noto Sans JP", sans-serif;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 6px;
    }
    h2 {
      font-size: 1.05rem;
      margin: 18px 0 8px;
      color: var(--muted);
    }
    .card {
      background: rgba(8, 15, 36, 0.9);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      border: 1px solid rgba(120, 140, 200, 0.35);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(12px);
    }
    label {
      font-size: 0.85rem;
      color: var(--muted);
      display: block;
      margin-bottom: 4px;
    }
    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(140, 160, 220, 0.6);
      background: rgba(3, 8, 25, 0.9);
      color: var(--fg);
      font-size: 0.9rem;
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(90, 169, 255, 0.6);
    }
    button {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #5aa9ff, #4ad2ff);
      color: #020409;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .col {
      flex: 1 1 150px;
      min-width: 0;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 16px;
      font-size: 0.9rem;
    }
    .label {
      color: var(--muted);
      font-size: 0.8rem;
    }
    .value {
      font-family: "SF Mono", "Roboto Mono", Consolas, monospace;
      font-size: 0.9rem;
      text-align: right;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(90, 169, 255, 0.16);
      border: 1px solid rgba(90, 169, 255, 0.5);
      color: var(--accent);
      margin-left: 8px;
    }
    .small {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 4px;
    }
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 4px;
      background: var(--danger);
    }
    .status-dot.ok {
      background: var(--good);
    }
    .status-text {
      font-size: 0.8rem;
      color: var(--muted);
      vertical-align: middle;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>
    Tele GPS system
    <span class="badge">ver0.1</span>
  </h1>

  <div class="card">
    <h2>接続設定</h2>
    <div class="row">
      <div class="col">
        <label>ルームID</label>
        <input id="roomId" placeholder="例: test01, abcd01" />
      </div>
      <div class="col">
        <label>端末ID</label>
        <select id="deviceId">
          <option value="A">Ａ</option>
          <option value="B">Ｂ</option>
        </select>
      </div>
    </div>
    <button id="connectBtn">接続 & 位置共有開始</button>
    <div class="small">
      ・2台とも同じルームIDで接続する。<br>
      ・一方を「A」、もう一方を「B」にする。<br>
      ・接続後、位置情報の使用を許可する。（HTTPS推奨）
    </div>
    <div class="small" style="margin-top:6px;">
      <span id="statusDot" class="status-dot"></span>
      <span id="statusText" class="status-text">未接続</span>
    </div>
  </div>

  <div class="card">
    <h2>自分の位置</h2>
    <div class="grid">
      <div class="label">緯度</div>
      <div class="value" id="selfLat">----</div>

      <div class="label">経度</div>
      <div class="value" id="selfLon">----</div>

      <div class="label">海抜高度</div>
      <div class="value" id="selfAlt">----</div>

      <div class="label">測位時刻</div>
      <div class="value" id="selfTime">----</div>

      <div class="label">速度</div>
      <div class="value" id="selfSpeed">----</div>

      <div class="label">COG</div>
      <div class="value" id="selfCog">----</div>
    </div>
  </div>

  <div class="card">
    <h2>相手の位置</h2>
    <div class="grid">
      <div class="label">緯度</div>
      <div class="value" id="otherLat">----</div>

      <div class="label">経度</div>
      <div class="value" id="otherLon">----</div>

      <div class="label">海抜高度</div>
      <div class="value" id="otherAlt">----</div>

      <div class="label">測位時刻</div>
      <div class="value" id="otherTime">----</div>

      <div class="label">速度</div>
      <div class="value" id="otherSpeed">----</div>

      <div class="label">COG</div>
      <div class="value" id="otherCog">----</div>
    </div>
  </div>

  <div class="card">
    <h2>相対情報（自分から見た相手）</h2>
    <div class="grid">
      <div class="label">距離</div>
      <div class="value" id="relDistance">----</div>

      <div class="label">方位（真方位）</div>
      <div class="value" id="relBearing">----</div>
    </div>
    <div class="small">
      ※距離と方位は、双方の位置が取得できた時に自動計算されます。
    </div>
  </div>
</div>
<h2 style="text-align:center">福岡県立水産高等学校 海洋科 航海コース</h2>

<!-- Firebase（compat版）CDN：Realtime Database を利用 -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.3.0/firebase-app-compat.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/12.3.0/firebase-database-compat.min.js"></script>

<script>
  // ==== ここをあなたの Firebase 設定に書き換えてください ====
  // Firebaseコンソール→「アプリを追加（Web）」で出てくる設定オブジェクト
  const firebaseConfig = {
    apiKey: "AIzaSyAyDeKjhbCLrX3P53xfT8MZqraiMIfw3oc",
    authDomain: "tele-gps.firebaseapp.com",
    databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
    projectId: "tele-gps",
    storageBucket: "tele-gps.firebasestorage.app",
    messagingSenderId: "802995237242",
    appId: "df99182d8600abeaa566c3"
  };
  // ===========================================================

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const connectBtn = document.getElementById("connectBtn");
  const roomInput = document.getElementById("roomId");
  const deviceSelect = document.getElementById("deviceId");
  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");

  let roomId = null;
  let deviceId = null;
  let otherId = null;
  let watchId = null;

  let lastSelfPos = null; // {lat, lon, t}
  let lastSelfCog = null;

  let selfData = null;
  let otherData = null;

  function setStatus(ok, text) {
    if (ok) {
      statusDot.classList.add("ok");
    } else {
      statusDot.classList.remove("ok");
    }
    statusText.textContent = text;
  }

  function toDMS(deg, isLat) {
    if (deg === null || deg === undefined) return "----";
    const abs = Math.abs(deg);
    const d = Math.floor(abs);
    const min = (abs - d) * 60;
    const m = Math.floor(min);
    const s = (min - m) * 60;
    const hemi = isLat ? (deg >= 0 ? "N" : "S") : (deg >= 0 ? "E" : "W");
    return `${hemi} ${d}°${m}'${s.toFixed(4)}"`;
  }

  function formatTime(ts) {
    if (!ts) return "----";
    const d = new Date(ts);
    return d.toLocaleString("ja-JP");
  }

  function msToSpeedStrings(ms) {
    if (ms === null || ms === undefined || isNaN(ms)) return "----";
    const kmh = ms * 3.6;
    const knots = ms * 1.943844;
    return `${kmh.toFixed(1)} km/h / ${knots.toFixed(2)} kt`;
  }

  function bearingDeg(lat1, lon1, lat2, lon2) {
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1) * Math.sin(φ2) -
              Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    let brng = θ * 180 / Math.PI;
    brng = (brng + 360) % 360;
    return brng;
  }

  function distanceMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000; // m
    const φ1 = lat1 * Math.PI / 180;
    const φ2 = lat2 * Math.PI / 180;
    const Δφ = (lat2 - lat1) * Math.PI / 180;
    const Δλ = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function updateSelfUI(data) {
    document.getElementById("selfLat").textContent =
      toDMS(data.lat, true);
    document.getElementById("selfLon").textContent =
      toDMS(data.lon, false);
    document.getElementById("selfAlt").textContent =
      data.alt !== null && data.alt !== undefined
        ? data.alt.toFixed(1) + " m"
        : "----";
    document.getElementById("selfTime").textContent =
      formatTime(data.t);
    document.getElementById("selfSpeed").textContent =
      msToSpeedStrings(data.speed);
    document.getElementById("selfCog").textContent =
      data.cog !== null && data.cog !== undefined
        ? data.cog.toFixed(1) + "°"
        : "----";
  }

  function updateOtherUI(data) {
    document.getElementById("otherLat").textContent =
      data ? toDMS(data.lat, true) : "----";
    document.getElementById("otherLon").textContent =
      data ? toDMS(data.lon, false) : "----";
    document.getElementById("otherAlt").textContent =
      data && data.alt !== null && data.alt !== undefined
        ? data.alt.toFixed(1) + " m"
        : "----";
    document.getElementById("otherTime").textContent =
      data ? formatTime(data.t) : "----";
    document.getElementById("otherSpeed").textContent =
      data ? msToSpeedStrings(data.speed) : "----";
    document.getElementById("otherCog").textContent =
      data && data.cog !== null && data.cog !== undefined
        ? data.cog.toFixed(1) + "°"
        : "----";
  }

  function updateRelativeUI() {
    const distElem = document.getElementById("relDistance");
    const brgElem = document.getElementById("relBearing");

    if (!selfData || !otherData) {
      distElem.textContent = "----";
      brgElem.textContent = "----";
      return;
    }
    const d = distanceMeters(selfData.lat, selfData.lon,
                             otherData.lat, otherData.lon);
    const b = bearingDeg(selfData.lat, selfData.lon,
                         otherData.lat, otherData.lon);
    distElem.textContent = d.toFixed(1) + " m";
    brgElem.textContent = b.toFixed(1) + "°";
  }

  function startGeolocation() {
    if (!navigator.geolocation) {
      setStatus(false, "この端末は Geolocation API に対応していません。");
      return;
    }

    setStatus(true, "位置情報取得中…");

    watchId = navigator.geolocation.watchPosition(
      (pos) => {
        const c = pos.coords;
        const now = pos.timestamp;

        // COG計算：1つ前の位置があれば方位を計算
        let cog = null;
        if (lastSelfPos &&
            (c.latitude !== lastSelfPos.lat ||
             c.longitude !== lastSelfPos.lon)) {
          cog = bearingDeg(
            lastSelfPos.lat, lastSelfPos.lon,
            c.latitude, c.longitude
          );
          lastSelfCog = cog;
        } else if (lastSelfCog !== null) {
          cog = lastSelfCog;
        }

        lastSelfPos = {
          lat: c.latitude,
          lon: c.longitude,
          t: now
        };

        selfData = {
          lat: c.latitude,
          lon: c.longitude,
          alt: c.altitude,
          speed: c.speed,
          cog: cog,
          t: now
        };

        // 自分の表示更新
        updateSelfUI(selfData);

        // Firebase に書き込み
        if (roomId && deviceId) {
          const ref = db.ref(`rooms/${roomId}/${deviceId}`);
          ref.set(selfData).catch((err) => {
            console.error("DB write error:", err);
            setStatus(false, "Firebase書き込みエラー");
          });
        }

        // 相対情報更新
        updateRelativeUI();
      },
      (err) => {
        console.error(err);
        setStatus(false, "位置情報取得エラー: " + err.message);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      }
    );
  }

  function listenOther() {
    if (!roomId || !otherId) return;
    const ref = db.ref(`rooms/${roomId}/${otherId}`);
    ref.on("value", (snap) => {
      const val = snap.val();
      if (val) {
        otherData = val;
        updateOtherUI(otherData);
        updateRelativeUI();
        setStatus(true, "接続中（相手のデータ受信）");
      } else {
        otherData = null;
        updateOtherUI(null);
        updateRelativeUI();
        setStatus(true, "接続中（相手のデータ待機中…）");
      }
    }, (err) => {
      console.error("DB read error:", err);
      setStatus(false, "Firebase読み込みエラー");
    });
  }

  connectBtn.addEventListener("click", () => {
    const r = roomInput.value.trim();
    const d = deviceSelect.value;

    if (!r) {
      alert("ルームIDを入力してください。");
      return;
    }

    roomId = r;
    deviceId = d;
    otherId = (d === "A") ? "B" : "A";

    roomInput.disabled = true;
    deviceSelect.disabled = true;
    connectBtn.disabled = true;

    setStatus(true, "Firebase接続 & 位置取得開始…");

    startGeolocation();
    listenOther();
  });
</script>
</body>
</html>
